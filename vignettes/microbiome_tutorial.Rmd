---
title: "microbiome_tutorial"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{microbiome_tutorial}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>"
)
```

```{r setup}
library(FAVA)
library(dplyr)
library(tidyr)
library(ggplot2)
```


In this tutorial, I visualize the relative abundances of 

I accomplish these tasks using two files, both of which are included as example data in the FAVA R package:

* `xue_microbiome_sample` is a dataframe containing 77 microbiome samples generated by Xue et al. (2023), each from one of three subjects (XBA, XDA, and XMA) at a series of time points between study day 1 and day 64. Each row of `xue_microbiome_sample` represents a single microbiome sample. `xue_microbiome_sample` has 526 columns: 

    * `subject` - the subject each sample corresponds to 

    * `timepoint` - the study day at which at sample was taken

    * `Actinomyces_sp_58647`, ..., `Xenorhabdus_bovienii_57960` - the relative abundance of the corresponding bacterial species (there are 524 species in total)
    
* `xue_species_similarity` is a similarity matrix containing the similarity of every pair of species included in `xue_microbiome_sample`. 



# 1 - Visualize relative abundances

Here are the first ten rows and the first seven columns of our example relative abundance matrix,`xue_microbiome_sample`:
```{r}
knitr::kable(xue_microbiome_sample[1:10, 1:7])
```

We can visualize all of the relative abundances using the `plot_relabund` function:
```{r}
set.seed(1)
species_palette = viridis::turbo(524)[sample(1:524)] %>%
  `names<-`(colnames(xue_microbiome_sample)[-c(1:2)])

plot_relaband(xue_microbiome_sample, group = "subject", time = "timepoint", arrange = "vertical") + 
  ggplot2::scale_color_manual(values = species_palette) + 
  ggplot2::scale_fill_manual(values = species_palette)
```

This data set contains relative abundance samples from multiple subjects that were taken at uneven timepoints. We can account for this in our visualization by providing the column name that describes which group each sample belongs to (`group = "subject"`) as well as which time each sample corresponds to (`time= "timepoint"`). Providing a `group` results in a plot that has one facet for each subset. Providing 


# 2 - Compute unweighted FAVA across all relative abundances for each subject

```{r}
fava(relab_matrix = xue_microbiome_sample, group = "subject", K = 524)
```

# 3 - Compute weighted FAVA across all relative abundances for each subject



## Use this species similarity matrix to compute FAVA for each subject

Note that, since every column is now accounted for after providing group and timepoint, we no longer need to specify `K`.
```{r}
fava(relab_matrix = xue_microbiome_sample, 
     group = "subject", 
     time = "timepoint", S = xue_species_similarity)

```

# 4 - Compute FAVA in sliding windows six samples wide for each subject

## Compute FAVA for each window
```{r}
# window_out = window_fava( Q = xue_microbiome_sample,
#                          K = 524,
#                          w = time_weights(times = xue_microbiome_sample$timepoint, 
#                               group = xue_microbiome_sample$subject),
#                          S = sp.sim,
#                          window_size = 6, 
#                          group = "subject", 
#                          index = "timepoint")
# head(window_out)
```

## Visualize FAVA in sliding windows
```{r}
# window_plot(window_out)
# window_plot(window_out) + facet_wrap(~ group)
```

